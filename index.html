import React, { useState, useEffect, useRef } from 'react';
import { ShoppingBag, User, Home, Plus, Minus, X, ArrowLeft, MapPin, Phone, CreditCard, Package, Truck, Check } from 'lucide-react';

// --- MOCK DATA & CONSTANTS ---

const PRODUCTS = [
  { id: 1, name: 'Пионовый Закат', price: 4500, image: 'https://images.unsplash.com/photo-1563241527-3004b7be025b?auto=format&fit=crop&q=80&w=800' },
  { id: 2, name: 'Нежная Роза', price: 3200, image: 'https://images.unsplash.com/photo-1582794543139-8ac5ea5a01f6?auto=format&fit=crop&q=80&w=800' },
  { id: 3, name: 'Дикий Луг', price: 2800, image: 'https://images.unsplash.com/photo-1494336934272-f0efcedfc8d7?auto=format&fit=crop&q=80&w=800' },
  { id: 4, name: 'Королевский Синий', price: 5600, image: 'https://images.unsplash.com/photo-1562690868-60bbe7621e6c?auto=format&fit=crop&q=80&w=800' },
  { id: 5, name: 'Белое Облако', price: 4100, image: 'https://images.unsplash.com/photo-1561181286-d3fee7d55364?auto=format&fit=crop&q=80&w=800' },
];

const PACKAGING_OPTIONS = [
  { id: 'transport', name: 'Транспортировочная', price: 0, desc: 'Для доставки' },
  { id: 'craft', name: 'Крафт-бумага', price: 0, desc: 'Эко-минимализм' },
  { id: 'box', name: 'Коробка-чемодан', price: 400, desc: 'С ручкой + уход' },
];

// Эмуляция данных Telegram (если не в приложении)
const MOCK_TG_USER = {
  id: 777,
  first_name: "Jonbella",
  username: "soul_note",
  photo_url: null
};

// --- COMPONENTS ---

// 1. Reusable Glass Card
const GlassCard = ({ children, className = '', onClick }) => (
  <div 
    onClick={onClick}
    className={`bg-white/5 backdrop-blur-2xl border border-white/10 rounded-[32px] p-5 shadow-xl ${className}`}
  >
    {children}
  </div>
);

// 2. Input Field Component
const InputField = ({ label, value, onChange, placeholder, type = "text" }) => (
  <div className="flex flex-col space-y-2">
    <label className="text-gray-400 text-xs ml-2 uppercase tracking-wider font-semibold">{label}</label>
    <input
      type={type}
      value={value}
      onChange={onChange}
      placeholder={placeholder}
      className="bg-white/5 border border-white/10 rounded-2xl px-4 py-3 text-white placeholder-gray-600 focus:outline-none focus:border-red-400/50 transition-colors"
    />
  </div>
);

export default function App() {
  // --- STATE ---
  const [activeTab, setActiveTab] = useState('catalog');
  const [cart, setCart] = useState({}); // { [id]: quantity }
  const [orders, setOrders] = useState([]);
  const [userData, setUserData] = useState({
    name: '',
    phone: '',
    city: '',
    street: '',
    house: '',
    apt: ''
  });
  
  // Checkout Specific State
  const [isCheckoutOpen, setIsCheckoutOpen] = useState(false);
  const [deliveryMethod, setDeliveryMethod] = useState('delivery'); // 'delivery' | 'pickup'
  const [packaging, setPackaging] = useState('transport');
  const [recipient, setRecipient] = useState('me'); // 'me' | 'other'
  const [recipientInfo, setRecipientInfo] = useState({ name: '', phone: '', comment: '' });

  const tgRef = useRef(null);

  // --- EFFECTS ---

  // Инициализация Telegram и загрузка данных
  useEffect(() => {
    if (window.Telegram && window.Telegram.WebApp) {
      tgRef.current = window.Telegram.WebApp;
      tgRef.current.ready();
      tgRef.current.expand();
      tgRef.current.setHeaderColor('#000000');
      tgRef.current.setBackgroundColor('#000000');
    }

    // Загрузка сохраненных данных
    const savedData = localStorage.getItem('nebuket_user_data');
    if (savedData) {
      setUserData(JSON.parse(savedData));
    } else {
      // Предзаполнение из ТГ, если нет сохраненных
      const user = tgRef.current?.initDataUnsafe?.user || MOCK_TG_USER;
      setUserData(prev => ({ ...prev, name: user.first_name || '' }));
    }

    const savedOrders = localStorage.getItem('nebuket_orders');
    if (savedOrders) setOrders(JSON.parse(savedOrders));
  }, []);

  // Сохранение данных пользователя при изменении
  useEffect(() => {
    localStorage.setItem('nebuket_user_data', JSON.stringify(userData));
  }, [userData]);

  // --- LOGIC ---

  const addToCart = (id) => {
    setCart(prev => ({ ...prev, [id]: (prev[id] || 0) + 1 }));
    haptic('light');
  };

  const removeFromCart = (id) => {
    setCart(prev => {
      const newCart = { ...prev };
      if (newCart[id] > 1) {
        newCart[id]--;
      } else {
        delete newCart[id];
      }
      return newCart;
    });
    haptic('light');
  };

  const haptic = (style) => {
    if (tgRef.current?.HapticFeedback) {
      tgRef.current.HapticFeedback.impactOccurred(style);
    }
  };

  const getCartTotal = () => {
    let total = 0;
    Object.entries(cart).forEach(([id, qty]) => {
      const product = PRODUCTS.find(p => p.id === parseInt(id));
      if (product) total += product.price * qty;
    });
    return total;
  };

  const getFinalTotal = () => {
    const cartTotal = getCartTotal();
    const packPrice = PACKAGING_OPTIONS.find(p => p.id === packaging)?.price || 0;
    return cartTotal + packPrice;
  };

  const handlePhoneChange = (e, setter) => {
    let val = e.target.value.replace(/\D/g, '');
    if (val.length > 0 && val[0] !== '7') val = '7' + val;
    val = val.substring(0, 11);
    
    let formatted = '';
    if (val.length > 0) formatted += '+7';
    if (val.length > 1) formatted += ' (' + val.substring(1, 4);
    if (val.length > 4) formatted += ') ' + val.substring(4, 7);
    if (val.length > 7) formatted += '-' + val.substring(7, 9);
    if (val.length > 9) formatted += '-' + val.substring(9, 11);

    setter(prev => ({ ...prev, phone: formatted }));
  };

  const submitOrder = () => {
    const newOrder = {
      id: Date.now(),
      date: new Date().toLocaleDateString(),
      items: cart,
      total: getFinalTotal(),
      status: 'В обработке',
      packaging: PACKAGING_OPTIONS.find(p => p.id === packaging).name,
      delivery: deliveryMethod
    };

    const updatedOrders = [newOrder, ...orders];
    setOrders(updatedOrders);
    localStorage.setItem('nebuket_orders', JSON.stringify(updatedOrders));
    
    setCart({});
    setIsCheckoutOpen(false);
    setActiveTab('profile');
    haptic('success');
    
    // В реальном приложении здесь отправка данных боту через tgRef.current.sendData()
  };

  // --- RENDER SCREENS ---

  const renderCatalog = () => (
    <div className="pb-24 px-4 pt-6 space-y-6">
      <div className="flex justify-between items-end">
        <div>
          <h1 className="text-3xl font-bold text-white tracking-tight">Ne buket</h1>
          <p className="text-white/60 text-sm mt-1">Искусство дарить эмоции</p>
        </div>
        <div className="w-10 h-10 rounded-full bg-gradient-to-tr from-red-500 to-orange-500 blur-lg opacity-50 absolute right-4 top-8"></div>
      </div>

      <div className="grid grid-cols-2 gap-4">
        {PRODUCTS.map(product => (
          <GlassCard key={product.id} className="p-0 overflow-hidden group active:scale-95 transition-transform duration-200">
            <div className="relative aspect-[3/4]">
              <img src={product.image} alt={product.name} className="w-full h-full object-cover" />
              <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-90" />
              
              <div className="absolute bottom-0 left-0 w-full p-3">
                <h3 className="font-medium text-white text-sm truncate">{product.name}</h3>
                <div className="flex justify-between items-center mt-1">
                  <span className="font-bold text-white">{product.price.toLocaleString()} ₽</span>
                  
                  {cart[product.id] ? (
                    <div className="flex items-center space-x-2 bg-white/20 backdrop-blur-md rounded-full px-2 py-1">
                      <button onClick={(e) => {e.stopPropagation(); removeFromCart(product.id)}} className="text-white"><Minus size={14}/></button>
                      <span className="text-xs font-bold">{cart[product.id]}</span>
                      <button onClick={(e) => {e.stopPropagation(); addToCart(product.id)}} className="text-white"><Plus size={14}/></button>
                    </div>
                  ) : (
                    <button 
                      onClick={(e) => {e.stopPropagation(); addToCart(product.id)}}
                      className="bg-white/20 hover:bg-white/30 p-1.5 rounded-full backdrop-blur-md transition-colors"
                    >
                      <Plus size={18} className="text-white" />
                    </button>
                  )}
                </div>
              </div>
            </div>
          </GlassCard>
        ))}
      </div>
    </div>
  );

  const renderCart = () => {
    const hasItems = Object.keys(cart).length > 0;

    if (isCheckoutOpen) return renderCheckout();

    return (
      <div className="pb-24 px-4 pt-6 h-full flex flex-col">
        <h1 className="text-3xl font-bold text-white mb-6">Корзина</h1>
        
        {!hasItems ? (
          <div className="flex-1 flex flex-col items-center justify-center text-white/40 space-y-4">
            <ShoppingBag size={64} strokeWidth={1} />
            <p>Ваша корзина пуста</p>
          </div>
        ) : (
          <div className="flex-1 overflow-y-auto space-y-3">
            {Object.entries(cart).map(([id, qty]) => {
              const product = PRODUCTS.find(p => p.id === parseInt(id));
              return (
                <GlassCard key={id} className="flex items-center space-x-4 p-3">
                  <img src={product.image} className="w-16 h-16 rounded-xl object-cover" alt="" />
                  <div className="flex-1">
                    <h3 className="font-medium text-white">{product.name}</h3>
                    <p className="text-white/50 text-sm">{product.price.toLocaleString()} ₽</p>
                  </div>
                  <div className="flex flex-col items-center space-y-1">
                    <button onClick={() => addToCart(product.id)} className="bg-white/10 p-1 rounded-full"><Plus size={14} /></button>
                    <span className="text-sm font-bold">{qty}</span>
                    <button onClick={() => removeFromCart(product.id)} className="bg-white/10 p-1 rounded-full"><Minus size={14} /></button>
                  </div>
                </GlassCard>
              );
            })}
          </div>
        )}

        {hasItems && (
          <div className="mt-4 pt-4 border-t border-white/10">
            <div className="flex justify-between text-white mb-4 px-2">
              <span className="text-white/60">Итого:</span>
              <span className="font-bold text-xl">{getCartTotal().toLocaleString()} ₽</span>
            </div>
            <button 
              onClick={() => setIsCheckoutOpen(true)}
              className="w-full bg-gradient-to-r from-red-500 to-orange-600 text-white font-bold py-4 rounded-2xl shadow-[0_0_20px_rgba(239,68,68,0.4)] active:scale-95 transition-transform"
            >
              Оформить заказ
            </button>
          </div>
        )}
      </div>
    );
  };

  const renderCheckout = () => {
    const user = tgRef.current?.initDataUnsafe?.user || MOCK_TG_USER;

    return (
      <div className="pb-24 px-4 pt-4">
        <div className="flex items-center space-x-3 mb-6">
          <button onClick={() => setIsCheckoutOpen(false)} className="p-2 bg-white/5 rounded-full"><ArrowLeft size={20} /></button>
          <h2 className="text-xl font-bold">Оформление</h2>
        </div>

        <div className="space-y-6 overflow-y-auto pb-8">
          {/* Greeting */}
          <div className="flex items-center space-x-3 bg-gradient-to-r from-red-500/20 to-transparent p-4 rounded-2xl border border-red-500/20">
            <User className="text-red-400" />
            <div>
              <p className="text-xs text-red-300">Оформляем для</p>
              <p className="font-bold">{user.first_name} {user.last_name}</p>
            </div>
          </div>

          {/* Delivery Method */}
          <div className="space-y-3">
            <label className="text-sm text-gray-400 uppercase font-bold ml-1">Способ получения</label>
            <div className="grid grid-cols-2 gap-3">
              <button 
                onClick={() => setDeliveryMethod('delivery')}
                className={`p-4 rounded-2xl border transition-all ${deliveryMethod === 'delivery' ? 'bg-white text-black border-white' : 'bg-white/5 border-white/10'}`}
              >
                <Truck className="mb-2" />
                <div className="font-bold text-sm">Доставка</div>
              </button>
              <button 
                onClick={() => setDeliveryMethod('pickup')}
                className={`p-4 rounded-2xl border transition-all ${deliveryMethod === 'pickup' ? 'bg-white text-black border-white' : 'bg-white/5 border-white/10'}`}
              >
                <Package className="mb-2" />
                <div className="font-bold text-sm">Самовывоз</div>
              </button>
            </div>
          </div>

          {/* Packaging */}
          <div className="space-y-3">
            <label className="text-sm text-gray-400 uppercase font-bold ml-1">Упаковка</label>
            <div className="space-y-2">
              {PACKAGING_OPTIONS.map(opt => (
                <div 
                  key={opt.id}
                  onClick={() => setPackaging(opt.id)}
                  className={`flex justify-between items-center p-4 rounded-2xl border transition-all cursor-pointer ${packaging === opt.id ? 'bg-white/10 border-red-500/50' : 'bg-white/5 border-white/5'}`}
                >
                  <div>
                    <div className="font-bold text-sm">{opt.name}</div>
                    <div className="text-xs text-gray-400">{opt.desc}</div>
                  </div>
                  <div className="font-bold text-red-400">{opt.price === 0 ? 'Бесплатно' : `${opt.price} ₽`}</div>
                </div>
              ))}
            </div>
          </div>

          {/* Contact Info */}
          <GlassCard className="space-y-4">
            <h3 className="font-bold text-lg mb-2">Ваши данные</h3>
            <InputField 
              label="Имя" 
              value={userData.name} 
              onChange={(e) => setUserData({...userData, name: e.target.value})} 
            />
            <div className="flex flex-col space-y-2">
               <label className="text-gray-400 text-xs ml-2 uppercase tracking-wider font-semibold">Телефон</label>
               <input
                type="tel"
                value={userData.phone}
                onChange={(e) => handlePhoneChange(e, setUserData)}
                placeholder="+7 (999) 000-00-00"
                className="bg-white/5 border border-white/10 rounded-2xl px-4 py-3 text-white placeholder-gray-600 focus:outline-none focus:border-red-400/50 transition-colors"
              />
            </div>
            
            {deliveryMethod === 'delivery' && (
              <>
                <div className="border-t border-white/10 my-4"></div>
                <h3 className="font-bold text-lg mb-2">Адрес доставки</h3>
                <InputField label="Город" value={userData.city} onChange={(e) => setUserData({...userData, city: e.target.value})} />
                <InputField label="Улица" value={userData.street} onChange={(e) => setUserData({...userData, street: e.target.value})} />
                <div className="flex space-x-3">
                  <InputField label="Дом" value={userData.house} onChange={(e) => setUserData({...userData, house: e.target.value})} />
                  <InputField label="Кв/Офис" value={userData.apt} onChange={(e) => setUserData({...userData, apt: e.target.value})} />
                </div>
              </>
            )}
          </GlassCard>

          {/* Recipient Logic */}
          {deliveryMethod === 'delivery' && (
            <GlassCard className="space-y-4">
              <h3 className="font-bold text-lg mb-2">Кому звонить?</h3>
              <div className="flex bg-black/40 p-1 rounded-xl">
                <button 
                  onClick={() => setRecipient('me')} 
                  className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${recipient === 'me' ? 'bg-white/20 text-white shadow-lg' : 'text-gray-400'}`}
                >
                  Мне
                </button>
                <button 
                  onClick={() => setRecipient('other')} 
                  className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${recipient === 'other' ? 'bg-white/20 text-white shadow-lg' : 'text-gray-400'}`}
                >
                  Получателю
                </button>
              </div>

              {recipient === 'other' && (
                <div className="space-y-4 pt-2 animate-in fade-in slide-in-from-top-2">
                  <InputField 
                    label="Имя получателя" 
                    value={recipientInfo.name} 
                    onChange={(e) => setRecipientInfo({...recipientInfo, name: e.target.value})} 
                  />
                  <div className="flex flex-col space-y-2">
                    <label className="text-gray-400 text-xs ml-2 uppercase tracking-wider font-semibold">Телефон получателя</label>
                    <input
                      type="tel"
                      value={recipientInfo.phone}
                      onChange={(e) => handlePhoneChange(e, setRecipientInfo)}
                      placeholder="+7 (999) 000-00-00"
                      className="bg-white/5 border border-white/10 rounded-2xl px-4 py-3 text-white placeholder-gray-600 focus:outline-none focus:border-red-400/50 transition-colors"
                    />
                  </div>
                  <InputField 
                    label="Комментарий (опц.)" 
                    value={recipientInfo.comment} 
                    onChange={(e) => setRecipientInfo({...recipientInfo, comment: e.target.value})} 
                  />
                </div>
              )}
            </GlassCard>
          )}

          {/* Total & Actions */}
          <div className="pt-4">
            <div className="flex justify-between items-center mb-6 px-2">
              <span className="text-gray-400">К оплате:</span>
              <span className="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                {getFinalTotal().toLocaleString()} ₽
              </span>
            </div>

            <button 
              onClick={submitOrder}
              className="w-full bg-white text-black font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform mb-3"
            >
              Передать на сборку
            </button>
            <button 
              onClick={() => setIsCheckoutOpen(false)}
              className="w-full text-red-400 py-3 font-medium active:opacity-70"
            >
              Отменить
            </button>
          </div>
        </div>
      </div>
    );
  };

  const renderProfile = () => {
    const user = tgRef.current?.initDataUnsafe?.user || MOCK_TG_USER;

    return (
      <div className="pb-24 px-4 pt-10 space-y-6">
         {/* Header */}
         <div className="flex items-center space-x-4">
           <div className="w-20 h-20 rounded-full bg-gradient-to-tr from-gray-700 to-gray-600 flex items-center justify-center border-4 border-white/5 shadow-2xl">
              {user.photo_url ? (
                <img src={user.photo_url} className="w-full h-full rounded-full" alt="avatar" />
              ) : (
                <span className="text-3xl font-bold text-white">{user.first_name[0]}</span>
              )}
           </div>
           <div>
             <h2 className="text-2xl font-bold">{user.first_name} {user.last_name}</h2>
             <p className="text-red-400">@{user.username || 'username'}</p>
           </div>
         </div>

         {/* Saved Delivery Data */}
         <GlassCard>
           <div className="flex justify-between items-center mb-4">
             <h3 className="font-bold text-lg">Данные доставки</h3>
             <MapPin size={18} className="text-gray-500"/>
           </div>
           <div className="space-y-3">
             <InputField label="Город" value={userData.city} onChange={(e) => setUserData({...userData, city: e.target.value})} />
             <InputField label="Улица" value={userData.street} onChange={(e) => setUserData({...userData, street: e.target.value})} />
             <div className="flex space-x-3">
                  <InputField label="Дом" value={userData.house} onChange={(e) => setUserData({...userData, house: e.target.value})} />
                  <InputField label="Кв" value={userData.apt} onChange={(e) => setUserData({...userData, apt: e.target.value})} />
            </div>
           </div>
         </GlassCard>

         {/* Order History */}
         <div>
           <h3 className="font-bold text-xl mb-4 pl-2">Мои заказы</h3>
           <div className="space-y-3">
             {orders.length === 0 ? (
               <p className="text-gray-500 text-center py-8">История заказов пуста</p>
             ) : (
               orders.map(order => (
                 <GlassCard key={order.id} className="flex justify-between items-center">
                   <div>
                     <div className="font-bold text-white">Заказ #{order.id.toString().slice(-4)}</div>
                     <div className="text-xs text-gray-400">{order.date} • {Object.values(order.items).reduce((a,b)=>a+b,0)} тв.</div>
                     <div className="text-xs text-gray-500 mt-1">{order.packaging}</div>
                   </div>
                   <div className="text-right">
                     <div className="font-bold text-red-400">{order.total.toLocaleString()} ₽</div>
                     <div className="text-[10px] bg-white/10 px-2 py-1 rounded-full mt-1 inline-block">{order.status}</div>
                   </div>
                 </GlassCard>
               ))
             )}
           </div>
         </div>
      </div>
    );
  };

  return (
    <div className="bg-black min-h-screen text-white font-sans selection:bg-red-500/30">
      {/* Background Ambience */}
      <div className="fixed top-[-20%] left-[-10%] w-[500px] h-[500px] bg-red-600/20 rounded-full blur-[120px] pointer-events-none"></div>
      <div className="fixed bottom-[-10%] right-[-10%] w-[400px] h-[400px] bg-blue-600/10 rounded-full blur-[100px] pointer-events-none"></div>

      {/* Main Content Area */}
      <div className="relative z-10 max-w-md mx-auto h-screen flex flex-col">
        <div className="flex-1 overflow-y-auto no-scrollbar">
          {activeTab === 'catalog' && renderCatalog()}
          {activeTab === 'cart' && renderCart()}
          {activeTab === 'profile' && renderProfile()}
        </div>
      </div>

      {/* Bottom Navigation */}
      {!isCheckoutOpen && (
        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-[360px] z-50">
          <div className="bg-white/10 backdrop-blur-xl border border-white/10 rounded-3xl p-2 flex justify-between items-center shadow-2xl">
            <button 
              onClick={() => setActiveTab('catalog')}
              className={`flex-1 flex flex-col items-center py-3 rounded-2xl transition-all duration-300 ${activeTab === 'catalog' ? 'bg-white text-black shadow-lg scale-105' : 'text-gray-400 hover:text-white'}`}
            >
              <Home size={24} strokeWidth={activeTab === 'catalog' ? 2.5 : 2} />
            </button>
            <button 
              onClick={() => setActiveTab('cart')}
              className={`flex-1 flex flex-col items-center py-3 rounded-2xl transition-all duration-300 relative ${activeTab === 'cart' ? 'bg-white text-black shadow-lg scale-105' : 'text-gray-400 hover:text-white'}`}
            >
              <ShoppingBag size={24} strokeWidth={activeTab === 'cart' ? 2.5 : 2} />
              {Object.keys(cart).length > 0 && activeTab !== 'cart' && (
                <div className="absolute top-2 right-8 w-2 h-2 bg-red-500 rounded-full"></div>
              )}
            </button>
            <button 
              onClick={() => setActiveTab('profile')}
              className={`flex-1 flex flex-col items-center py-3 rounded-2xl transition-all duration-300 ${activeTab === 'profile' ? 'bg-white text-black shadow-lg scale-105' : 'text-gray-400 hover:text-white'}`}
            >
              <User size={24} strokeWidth={activeTab === 'profile' ? 2.5 : 2} />
            </button>
          </div>
        </div>
      )}

      {/* Telegram Script */}
      <script src="https://telegram.org/js/telegram-web-app.js"></script>
    </div>
  );
}
